# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

The Answer App is a production-ready conversational search application that leverages **Vertex AI Agent Builder** and **Discovery Engine API** to provide generative AI-powered answers grounded in document data. It consists of a FastAPI backend service and Streamlit frontend with Google OAuth 2.0 authentication, deployed on Google Cloud Platform with multi-regional Cloud Run services.

## Tech Stack

- **Backend:** Python 3.13+ with FastAPI and Uvicorn
- **Frontend:** Streamlit with Google OAuth 2.0 authentication  
- **AI/ML:** Vertex AI Agent Builder, Discovery Engine API, Gemini models
- **Infrastructure:** Google Cloud Platform (Cloud Run, Load Balancer, BigQuery, Secret Manager, IAP)
- **IaC:** Terraform with GCS remote state
- **Package Management:** Poetry
- **Testing:** pytest with coverage

## Essential Commands

### Development
```bash
# Install dependencies
poetry install

# Run backend locally (port 8888)
poetry run uvicorn main:app --app-dir src/answer_app --reload --host localhost --port 8888

# Run frontend locally
poetry run streamlit run src/client/streamlit_app.py

# Generate local secrets configuration
poetry run write_secrets
```

### Testing
```bash
# Run all tests
poetry run pytest

# Run tests with coverage
poetry run coverage run -m pytest

# View coverage report
poetry run coverage report -m
```

### Version Management
```bash
# Manual version bump (dry run)
poetry run semantic-release version --dry-run

# Manual version bump and release
poetry run semantic-release version

# Generate changelog
poetry run semantic-release changelog
```

### Deployment & Infrastructure
```bash
# Complete deployment (bootstrap + deploy)
source ./scripts/install.sh

# Bootstrap project (APIs, service accounts, permissions)
source ./scripts/bootstrap.sh

# Configure environment variables
source ./scripts/set_variables.sh

# Test deployed endpoint
./scripts/test_endpoint.sh

# Complete cleanup
source ./scripts/uninstall.sh
```

## Architecture Overview

### Core Components
- **`src/answer_app/`** - FastAPI backend with `/answer`, `/feedback`, and `/healthz` endpoints
- **`src/client/`** - Streamlit frontend with OAuth authentication and conversation interface
- **`src/answer_app/discoveryengine_utils.py`** - Vertex AI Discovery Engine integration
- **`src/answer_app/utils.py`** - BigQuery logging and utility functions

### Infrastructure (Terraform)
- **`terraform/bootstrap/`** - Initial project setup (APIs, service accounts)
- **`terraform/main/`** - Main infrastructure deployment
- **`terraform/modules/answer-app/`** - Core application Cloud Run services
- **`terraform/modules/loadbalancer/`** - Global load balancer with SSL and IAP

### Configuration
- **`src/answer_app/config.yaml`** - Application settings, regions, domain configuration
- **`.streamlit/secrets/`** - OAuth client credentials (gitignored, generated by script)

## Key Architectural Patterns

### Service Communication
- Frontend and backend are separate Cloud Run services
- Service-to-service authentication using Google Cloud service accounts
- IAP (Identity-Aware Proxy) protects external access

### Data Flow
1. User authenticates via Google OAuth in Streamlit frontend
2. Frontend sends queries to FastAPI backend `/answer` endpoint
3. Backend calls Vertex AI Discovery Engine for grounded responses
4. Conversations and feedback logged to BigQuery for analytics

### Multi-Regional Deployment
- Cloud Run services deployed across 3 regions (us-central1, us-west1, us-east4)
- Global load balancer with automatic failover
- Configurable autoscaling with concurrency controls

## Documentation Structure

The repository uses a **modular documentation structure** for better maintainability:

- **`README.md`** - Concise overview with quick start, feature list with icons, and comprehensive navigation to detailed docs
- **`docs/installation/`** - Comprehensive setup guides (prerequisites, OAuth, deployment)
- **`docs/development/`** - Development guides and API documentation
- **`docs/infrastructure/`** - Infrastructure documentation (Terraform, Cloud Build, rollbacks, automation scripts)
- **`docs/troubleshooting/`** - Known issues and solutions

All detailed instructions are preserved in the modular docs with proper cross-references and back-navigation links. Each documentation file includes a "‚Üê Back to README" link for easy navigation.

### Complete Documentation Index
- **Installation & Deployment:**
  - `docs/installation/prerequisites.md` - Environment setup and prerequisites
  - `docs/installation/oauth-setup.md` - Step-by-step OAuth client configuration
  - `docs/installation/deployment.md` - Deployment and post-deployment steps
- **Development:**
  - `docs/development/development.md` - Local development, testing, and Docker usage
  - `docs/development/api-configuration.md` - Answer method configuration options
- **Infrastructure:**
  - `docs/infrastructure/terraform.md` - General Terraform patterns and best practices
  - `docs/infrastructure/bootstrap.md` - Initial project setup and service accounts
  - `docs/infrastructure/cloud-build.md` - Automated deployments and CI/CD
  - `docs/infrastructure/rollbacks.md` - Rolling back deployments and managing revisions
  - `docs/infrastructure/cloud_infra_changes.md` - Applying infrastructure-only changes
  - `docs/infrastructure/helper-scripts.md` - Automation scripts reference
- **Troubleshooting:**
  - `docs/troubleshooting/known-issues.md` - Common problems and solutions

## Development Notes

### Local Development Setup
- Both services can run locally with hot reload
- OAuth configuration requires setup in `.streamlit/secrets/`
- Use `scripts/set_variables.sh` to configure required environment variables
- Complete setup guide: `docs/development/development.md`

### Testing Strategy
- Comprehensive test coverage: 94% overall (100% for backend components)
- Unit tests for each major component with async/await patterns throughout
- HTTP mocking with pytest-httpx for external API calls
- Async testing support for FastAPI endpoints using `@pytest.mark.asyncio`
- Tests fail if environment variables are set - use clean shell session
- Complete test suite with fixtures in `conftest.py` for consistent mocking

### Security Considerations
- All external access protected by IAP
- Service-to-service authentication between Cloud Run services
- OAuth credentials stored in Secret Manager
- Domain restriction policies supported for enterprise deployments
- OAuth setup guide: `docs/installation/oauth-setup.md`

### Helper Scripts Reference
- `scripts/install.sh` - Complete deployment automation
- `scripts/bootstrap.sh` - Initial project setup
- `scripts/set_variables.sh` - Environment configuration
- `scripts/test_endpoint.sh` - Endpoint validation
- `scripts/uninstall.sh` - Complete cleanup
- Complete reference: `docs/infrastructure/helper-scripts.md`

### Required Environment Variables
- `PROJECT` - Google Cloud project ID
- `REGION` - Default compute region  
- `TF_VAR_terraform_service_account` - Terraform service account
- `TF_VAR_docker_image` - Docker image specifications for deployment

## Code Quality & Architecture Notes

### Async/Await Implementation
- **Fully async throughout**: All I/O operations properly use async/await patterns
- **FastAPI endpoints**: All endpoints that perform I/O are `async def` functions
- **Discovery Engine integration**: Uses `ConversationalSearchServiceAsyncClient` correctly
- **BigQuery integration**: Uses `asyncio.to_thread()` for non-blocking database operations
- **Consistent patterns**: All async functions properly await their dependencies

### Current Project Status (as of version 0.2.0)
- **Documentation accuracy**: 95% accurate with modular structure
- **Test coverage**: 94% overall, 100% for critical backend components
- **Architecture maturity**: Production-ready with enterprise security patterns
- **Infrastructure**: Multi-regional Cloud Run deployment with Terraform IaC
- **Dependencies**: Modern Python tooling with Poetry, up-to-date Google Cloud libraries
- **Version automation**: Semantic release with automated badge updates and changelog generation

### Key Configuration Files
- **`pyproject.toml`**: Current version 0.2.0, Python 3.13+ requirement, comprehensive dependencies
- **`src/answer_app/config.yaml`**: Application settings including preamble, regions, BigQuery tables
- **`.streamlit/config.toml`**: Streamlit server configuration with dark theme and OAuth secrets path